{% extends "base.html" %}

{% block content %}
<div class="px-4 py-6 sm:px-0" x-data="dashboardData()">
    <!-- Dashboard Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Dashboard</h1>
        <p class="mt-2 text-gray-600 dark:text-gray-400">Real-time analytics and monitoring</p>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Events per second -->
        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-bolt text-blue-500 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">
                                Events/sec
                            </dt>
                            <dd class="text-lg font-medium text-gray-900 dark:text-white" x-text="kpis.eventsPerSecond">
                                0
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Alerts -->
        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">
                                Active Alerts
                            </dt>
                            <dd class="text-lg font-medium text-gray-900 dark:text-white" x-text="kpis.activeAlerts">
                                0
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Latency -->
        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-clock text-green-500 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">
                                Avg Latency
                            </dt>
                            <dd class="text-lg font-medium text-gray-900 dark:text-white" x-text="kpis.avgLatency + 'ms'">
                                0ms
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Health -->
        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-heartbeat text-purple-500 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">
                                System Health
                            </dt>
                            <dd class="text-lg font-medium text-gray-900 dark:text-white" x-text="kpis.systemHealth">
                                Healthy
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Event Timeline -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Event Timeline</h3>
            <div class="h-64">
                <canvas id="eventTimelineChart"></canvas>
            </div>
        </div>

        <!-- Event Types Distribution -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Event Types</h3>
            <div class="h-64">
                <canvas id="eventTypesChart"></canvas>
            </div>
        </div>

        <!-- Processing Latency -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Processing Latency</h3>
            <div class="h-64">
                <canvas id="latencyChart"></canvas>
            </div>
        </div>

        <!-- Alert Status -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Alert Status</h3>
            <div class="h-64">
                <canvas id="alertStatusChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Events -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg mb-8">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">Recent Events</h3>
        </div>
        <div class="px-6 py-4">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-900">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                Timestamp
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                Type
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                Source
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                Status
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <template x-for="event in recentEvents" :key="event.id">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100" x-text="new Date(event.timestamp).toLocaleTimeString()"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full" 
                                          :class="getEventTypeClass(event.type)" x-text="event.type"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100" x-text="event.source"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                                        Processed
                                    </span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Services Status -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Services</h3>
            <div class="space-y-3">
                <template x-for="service in services" :key="service.name">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-900 dark:text-gray-100" x-text="service.name"></span>
                        <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full"
                              :class="service.status === 'healthy' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                              x-text="service.status"></span>
                    </div>
                </template>
            </div>
        </div>

        <!-- Queue Status -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Queue Status</h3>
            <div class="space-y-3">
                <template x-for="queue in queues" :key="queue.name">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-900 dark:text-gray-100" x-text="queue.name"></span>
                        <span class="text-sm text-gray-600 dark:text-gray-400" x-text="queue.size + ' msgs'"></span>
                    </div>
                </template>
            </div>
        </div>

        <!-- Resource Usage -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Resources</h3>
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-900 dark:text-gray-100">CPU Usage</span>
                    <span class="text-sm text-gray-600 dark:text-gray-400" x-text="resources.cpu + '%'"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-900 dark:text-gray-100">Memory Usage</span>
                    <span class="text-sm text-gray-600 dark:text-gray-400" x-text="resources.memory + '%'"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-900 dark:text-gray-100">Disk Usage</span>
                    <span class="text-sm text-gray-600 dark:text-gray-400" x-text="resources.disk + '%'"></span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function dashboardData() {
    return {
        kpis: {
            eventsPerSecond: 1247,
            activeAlerts: 3,
            avgLatency: 23,
            systemHealth: 'Healthy'
        },
        recentEvents: [
            {
                id: '1',
                timestamp: new Date().toISOString(),
                type: 'user.login',
                source: 'web-app'
            },
            {
                id: '2',
                timestamp: new Date(Date.now() - 30000).toISOString(),
                type: 'api.request',
                source: 'mobile-app'
            },
            {
                id: '3',
                timestamp: new Date(Date.now() - 60000).toISOString(),
                type: 'system.warning',
                source: 'analytics-service'
            }
        ],
        services: [
            { name: 'Ingestion', status: 'healthy' },
            { name: 'Analytics', status: 'healthy' },
            { name: 'Alerting', status: 'healthy' },
            { name: 'Storage', status: 'healthy' }
        ],
        queues: [
            { name: 'ingestion', size: 156 },
            { name: 'analytics', size: 23 },
            { name: 'alerts', size: 0 }
        ],
        resources: {
            cpu: 45,
            memory: 62,
            disk: 78
        },
        
        getEventTypeClass(type) {
            const classes = {
                'user.login': 'bg-blue-100 text-blue-800',
                'user.logout': 'bg-gray-100 text-gray-800',
                'api.request': 'bg-green-100 text-green-800',
                'system.error': 'bg-red-100 text-red-800',
                'system.warning': 'bg-yellow-100 text-yellow-800',
                'system.info': 'bg-blue-100 text-blue-800'
            };
            return classes[type] || 'bg-gray-100 text-gray-800';
        },
        
        init() {
            this.initCharts();
            this.startRealTimeUpdates();
        },
        
        initCharts() {
            // Event Timeline Chart
            const timelineCtx = document.getElementById('eventTimelineChart').getContext('2d');
            new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Events',
                        data: Array.from({length: 24}, () => Math.floor(Math.random() * 1000) + 500),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Event Types Chart
            const typesCtx = document.getElementById('eventTypesChart').getContext('2d');
            new Chart(typesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['User Events', 'API Events', 'System Events', 'Custom Events'],
                    datasets: [{
                        data: [45, 30, 15, 10],
                        backgroundColor: [
                            'rgb(59, 130, 246)',
                            'rgb(34, 197, 94)',
                            'rgb(249, 115, 22)',
                            'rgb(168, 85, 247)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            // Latency Chart
            const latencyCtx = document.getElementById('latencyChart').getContext('2d');
            new Chart(latencyCtx, {
                type: 'bar',
                data: {
                    labels: ['< 10ms', '10-50ms', '50-100ms', '100-500ms', '> 500ms'],
                    datasets: [{
                        label: 'Requests',
                        data: [1200, 800, 400, 150, 50],
                        backgroundColor: 'rgba(34, 197, 94, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // Alert Status Chart
            const alertCtx = document.getElementById('alertStatusChart').getContext('2d');
            new Chart(alertCtx, {
                type: 'pie',
                data: {
                    labels: ['Active', 'Resolved', 'Suppressed'],
                    datasets: [{
                        data: [3, 25, 2],
                        backgroundColor: [
                            'rgb(239, 68, 68)',
                            'rgb(34, 197, 94)',
                            'rgb(156, 163, 175)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        },
        
        startRealTimeUpdates() {
            // Simulate real-time updates
            setInterval(() => {
                this.kpis.eventsPerSecond = Math.floor(Math.random() * 500) + 1000;
                this.kpis.avgLatency = Math.floor(Math.random() * 50) + 10;
            }, 5000);
        }
    }
}

// Global functions for WebSocket updates
window.updateMetricWidget = function(data) {
    // Update KPI cards with real-time data
    console.log('Updating metrics:', data);
};

window.showAlertNotification = function(alert) {
    // Show alert notification
    console.log('New alert:', alert);
};

window.updateEventCounter = function(data) {
    // Update event counter
    console.log('Event count update:', data);
};
</script>
{% endblock %}